model PushSubscription {
    id            String    @id @default(cuid())
    endpoint      String    @unique
    auth          String
    p256dh        String
    userId        String?
    user          User?     @relation(fields: [userId], references: [id])
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    lastSuccessAt DateTime?
    lastFailureAt DateTime?
    failedCount   Int       @default(0)

    @@index([userId])
}

model TopicSubscription {
    id        String    @id @default(cuid())
    userId    String
    user      User      @relation(fields: [userId], references: [id])
    topic     String // e.g., "timecardSubmissions"
    inApp     Boolean   @default(true)
    push      Boolean   @default(true)
    frequency Frequency @default(immediate)
    createdAt DateTime  @default(now())

    @@unique([userId, topic])
    @@index([topic])
}

model Notification {
    id        String   @id @default(cuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id])
    topic     String
    title     String
    body      String?
    url       String?
    metadata  Json?
    createdAt DateTime @default(now())

    // push state: null = not pushed / not scheduled; timestamp when push was sent
    pushedAt     DateTime?
    // if push failed attempts you can bump this
    pushAttempts Int       @default(0)

    readAt DateTime?

    @@index([userId, createdAt])
    @@index([topic, createdAt])
}

enum Frequency {
    immediate
    hourly
    daily
}
